Каждый год студенты и преподаватели собираются на даче за городом, чтобы отдохнуть от работы и поиграть в различные игры. Особую популярность приобрела игра в палочки. Чтобы подготовиться к соревнованию, требуется приложение для тренировки — об этом и задание. Описание игры: Имеется  палочек, расположенных в ряд(например: |). Играют двое по очереди: за ход игрок берёт палочки по определённым правилам. Кто не может сделать ход — проигрывает. Варианты правил(режимы игры): 

1.Стандартно: За ход можно взять от 1 до k (включительно) любых палочек. Брать можно любые палочки (не обязательно подряд). 

2.Интервальный выбор: За ход можно взять от a до b (включительно) любых палочек. 

3.Подряд: За ход можно взять от 1 до k подряд идущих палочек (никаких пропусков, только связный фрагмент, например, если палочки лежат как ||| ||, то взять 4 палочки не получится: тут изображено пустое пространство после третьей палочки, то есть палочку после третьей взяли на одном из предыдущих ходов). 

4.Подряд и интервально: За ход можно взять от  до  подряд идущих палочек. 

5.Особое: За ход разрешается взять либо 3 подряд идущих палочки, либо 1 любую палочку, либо 2 любые палочки. Именно в эту версию обычно на даче и играют! 

Для доказательства использовал информацию отсюда http://www.e-maxx-ru.1gb.ru/algo/sprague_grundy.
Все пять режимов ― это бесконечные, партизанские (имpartial) игры с обычным правилом конца — кто не может сходить, тот проиграл.
Оптимальная стратегия сводится к тому, чтобы после своего хода оставлять противнику проигрышную позицию.
Игра impartial (для обоих игроков набор ходов одинаков) с обычным правилом конца: кто не может сходить — проигрывает.
P‑позиции (previous player wins): для текущего ходящего всё плохо — любой его ход ведёт в N‑позицию, где соперник уже имеет ответ.
N‑позиции (next player wins): у текущего есть хотя бы один ход в P‑позицию.
Доказательство этих свойств проводится классической индукцией по «удалению ходов». На практике нам удобнее работать с ним‑числом (числом Гранди) G(position):

G = mex { G(child) } по всем позициям‑потомкам.
Теорема Шпрэгге—Гранди: позиция P ⇔ G=0, иначе N.
Для суммы независимых игр (несколько куч/сегментов, ход меняет ровно одну из них)
Отсюда стратегия: в N‑позиции сделать ход, после которого G=0; в P‑позиции победного хода не существует.
Режим 1. «1…k любых палочек»
Факт. Позиция проигрышна, если n mod (k+1) = 0
Докажем через индукцию :
База: n=0 — ходов нет ⇒ P.
Шаг 1 (если n mod (k+1)=0): любой ход m∈[1..k] даёт остаток 1..k ≠ 0 ⇒ попадём в N ⇒ исходная — P.
Шаг 2 (если n mod (k+1)=r∈[1..k]): взяв m=r, оставим кратное k+1 ⇒ попадём в P ⇒ исходная — N.
Режим 2. «a…b любых палочек»
Здесь, как и в режиме 1, важна только численность n.
Теорема. Обозначим L = a + b. Позиция — P ⇔ n mod L ∈ {0,1,…,a−1}.
Докажем через индукцию :
Пусть остаток будет равен r
Если остаток r < a и мы снимаем m∈[a,b], то новый остаток
r' ≡ r − m (mod L) попадает в диапазон L−(a−r), …, L−1 ⇒ r' ≥ a ⇒ N.
Значит из P нельзя пойти в P.
Если r ≥ a, то
— при a ≤ r ≤ b взять m=r → остаток 0 (P);
— при b < r ≤ L−1 взять m=b → остаток r−b ∈ [1, a−1] (P).
Значит из N всегда есть ход в P.
Режим 3. «1…k подряд» (связный отрезок) 
Ход удаляет смежный фрагмент внутри одного сегмента, раскалывая его на два (левый и правый). Разные сегменты независимы ⇒ применима теорема Шпрэгге—Гранди.
Определение. Пусть g[len] — ним‑число цельного сегмента длины len. Тогда
g[len]=mex{g[left]⊕g[right] | 1≤t≤k,0≤st≤len−t,left=st,right=len−t−st},g[0]=0.
Позиция со множеством сегментов len₁,…,len_m имеет ним‑число G = g[len₁] ⊕ … ⊕ g[len_m].
P ⇔ G=0. В N‑позиции есть ход (перебираем t, st), который делает XOR нулём.
Режим 4. «a…b подряд»
То же, только длина удаляемого отрезка — t∈[a..b].
Рекуррентная формула и доказательство идентичны режиму 3, меняется лишь множество допустимых t.
Режим 5. «3 подряд» или «1 любая» или «2 любые» (оптимально до n≤50)
Почему нельзя просто «XOR по сегментам»
Ход «2 любые» может удалить палочки из двух разных сегментов одновременно
(например, | . | → . . .). Для суммы независимых игр это запрещённый тип хода: он должен менять ровно один компонент. Поэтому формула «XOR(g[сегмент_i])» не применима.

Что делаем вместо этого
Мы считаем ним‑число всей позиции как функции мультисета длин сегментов.
Ключевая наблюдение: легальные ходы и их результаты зависят только от длин сегментов, а не от абсолютных координат палочек. Значит достаточно хранить отсортированный список длин
Перечень всех ходов из такой позиции
Пусть состояние — отсортированный список seg = (L₁, …, L_m).

Снять 1 палочку внутри одного сегмента длиной L:
выбираем позицию p=1..L, получаем до двух сегментов длиной p−1 и L−p.
Это даёт множество разбиений только от L, одинаковое для всех сегментов этой длины.

Снять 3 подряд внутри одного сегмента длиной L (если L≥3):
выбираем p=1..L−2, получаем сегменты p−1 и L−p−2 (0‑длины отбрасываем).

Снять 2 любые:

внутри одного сегмента длиной L≥2: выбираем 1≤i<j≤L, разбиение на 3 части i−1, j−i−1, L−j;
в двух разных сегментах L_i и L_j: снять по одной «в каждом» → объединяем результат двух случаев (1) для L_i и L_j.
Все полученные наборы длин сортируем и унифицируем (чтобы не дублировать одинаковые позиции).

Рекурсия на ним‑число
G(seg)=mex{G(seg') | seg - результат одного легального хода} 
  — результат одного легального хода},G(∅)=0.
Мы кешируем G(seg) по ключу «отсортированный список длин», что радикально уменьшает число состояний:
разбиений числа 50 всего P(50)=204 226, против 2^{50} битовых масок.

Оптимальный ход. Если G(seg) ≠ 0, мы гарантированно найдём дочернее seg' с G(seg')=0 (свойство N‑позиции): достаточно перебрать все типы ходов в фиксированном порядке и проверить ним‑число результата. Если G(seg)=0, выигрышного хода нет (любая попытка ведёт в N).
Лемма 1 (полнота). Множество дочерних состояний, которое мы перечисляем, совпадает с реальными ходами по правилам режима 5.
Доказательство. Три типа ходов (1, 2, 3‑подряд) разобраны полностью: перебираются все позиционирования внутри одного сегмента, а для «2 любые» дополнительно рассмотрен случай «в разных сегментах» как композиция двух операций типа (1). Обратного хода не требуется
Лемма 2 (достаточность представления). Значение G позиции зависит только от мультисета длин сегментов (а не от абсолютных координат оставшихся палочек).
Доказательство. Результат любого из трёх типов ходов внутри выбранных сегментов определяется только их длинами и относительными позициями удаляемых палочек внутри сегмента; абсолютные индексы на общем поле не играют роли. После удаления мы снова имеем набор сегментов, характеризуемый исключительно их длинами. Следовательно, переходы и ним‑число зависят лишь от мультисета длин. 
Теорема. Алгоритм (рекурсия mex по множеству всех дочерних состояний из Леммы 1 с ключом из Леммы 2) вычисляет точное ним‑число позиции.
Доказательство. Это прямое применение определения чисел Гранди для impartial‑игр (каждой позиции сопоставляется mex от чисел Гранди всех допустимых ходов из неё). Леммы гарантируют, что мы не потеряли ни одного дочернего состояния и что выбранное представление состояния полно. Следовательно, получаем корректное G. По теореме Шпрэгге—Гранди позиция P ⇔ G=0, N ⇔ G≠0. 

Следствие (оптимальность). Ход «сделать G=0» в N‑позиции существует и оптимален; в P‑позиции такого хода нет.
